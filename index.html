<html>
<head>
<title>Sweet</title>
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="shortcut icon" type="image/x-icon" href="http://www.matthewmorrone.com/psi.ico" />
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-color/2.1.2/jquery.color.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />
<script type="text/javascript" src="esprima.js"></script>
<script type="text/javascript" src="escodegen.js"></script>
<script type="text/javascript" src="estraverse.js"></script>

<link rel="import" href="editor.html" />
<style>
::-webkit-scrollbar {
	display: none;
}
* {
	margin: 0px;
	padding: 0px;
}
body {
	width: 100%;
	height: 100%;
}
table, th, td {
	border: 1px solid black;
	border-collapse: collapse;
}
input, button {
	line-height: initial;
	vertical-align: middle;
}
.CodeMirror {
	float: left;
}
.toggle {
	float: left;
}
main {
	display: flex;
	flex-flow: row nowrap;
}
#tree {
	width: 10%;
	height: 100%;
	float: left;
}
#files {
	width: 100%;
}
#filename, #files {
	border: none;
}
textarea:focus, input:focus, select:focus {
	outline: none;
}
*:focus {
	outline: none;
}
.folder {
	font-weight: bold;
}
</style>
</head>
<body>

<!-- <script type="text/javascript" src="starch.js"></script> -->
<script type="text/javascript" src="require.js"></script>
<script type="text/javascript" src="sweet.js"></script>
<script type="text/javascript" src="cm.js"></script>
<script>

var log = console.log.bind(console)

function updateFilelist(dir) {
	$.post('/api/', {
		mode: 'ls',
		handle: dir,
		dataType: 'json',
	}, function(d) {
		$('#files').empty()
		$("#files").attr('size', (d.length < 2 ? 2 : d.length))
		for(var i = 0; i < d.length; i++) {
			$("#files").append($('<option></option>', {text: d[i], value: d[i], class: (d[i].includes('.') ? '' : 'folder')}))
		}
		if (localStorage.getItem('filename')) {
			$('#files').val(localStorage.getItem('filename'))
		}
	}, 'json')
}
$(function() {
	var dir = window.location.pathname+'notes'
	updateFilelist(dir)
	requirejs(["sweet", "showdown"], function(sweet, showdown) {
		var cms = [], vals = [], x, y, cm, i, id, cma
		$('.gen').click(function() {
			$('textarea').each(function() {
				vals[$(this).attr('id')] = $(this).val()
				$(this).remove()
			})
			$('.toggle:not(:first-child), .CodeMirror, textarea').remove()
			x = parseInt($('#genx').val())
			y = parseInt($('#geny').val())
			for(i = 0; i < x*y; i++) {
				id = 'editor'+(i+1)
				$('main').append($('<textarea></textarea>', {id: id, val: vals[id]}))
			}
			$('textarea').each(function(i) {
				var cm = CodeMirror.fromTextArea($(this)[0], {
					lineNumbers: true,
					mode: {
						name: "javascript",
						globalVars: true
					},
					theme: 'default',
					scrollbarStyle: null,
					smartIndent: true,
					electricChars: true,
					tabSize: 4,
					indentWithTabs: true,
					inputStyle: "contenteditable",
					showCursorWhenSelecting: true,
					matchBrackets: true,
					autoCloseBrackets: true,
					foldGutter: true,
					gutters: [
						"CodeMirror-linenumbers",
						"CodeMirror-foldgutter"
					],
					extraKeys: {
						"Ctrl-Space": "test",
						// "Ctrl-Space": "autocomplete",
						"Enter": "newlineAndIndentContinueMarkdownList",
						"Ctrl-Down": "swapLineDown",
						"Ctrl-Enter": "insertLineBefore",
						"Ctrl-F": "findUnder",
						"Ctrl-F5": "sortLinesInsensitive",
						"Ctrl-L": "splitSelectionByLine",
						"Ctrl-Shift-L": "selectLine",
						"Ctrl-Up": "swapLineUp",
						"Ctrl-W": "wrapLines",
						"F5": "sortLines",
					},
					styleActiveLine: {nonEmpty: true},
					showTrailingSpace: true,
					matchTags: true,
					keyMap: 'sublime',
				})
				cm.index = i+1
				cms.push(cm)

				$(this).before($('<div class="toggle"></div>', {}))

				cm.setOption('theme', $('#theme').val())
				$(cm.display.wrapper).css({
					border: $('.CodeMirror-gutters').css('border-right'),
				})
				$(cm.display.wrapper).prevAll('.toggle:first').css({
					width: $('.CodeMirror-gutters').css('width'),
					height: $('.CodeMirror').css('height'),
					border: $('.CodeMirror-gutters').css('border-right'),
					backgroundColor: $('.CodeMirror-gutters').css('background-color'),
				})
			})
			$('.CodeMirror').width((90/x)+'%').height((100/y)+'%')

			cms.forEach(function(cm) {
				CodeMirror.on(cm, 'focus', function() {
					cma = cm
				})
				CodeMirror.on(cm, 'redraw', function() {
					$(cm.display.wrapper).prevAll('.toggle:first').css({
						height: $('.CodeMirror').height(),
					})
				})
			})

			CodeMirror.defineExtension('removeLine', function() {
				log(this.getValue())
			})


			CodeMirror.commands['test'] = function(cm) {
				cm.setValue(cm.getValue().replace(/\n$/, ''))
				cm.setValue(cm.getValue().replace(/^\n/, ''))


				// cm.eachLine(function(line) {
				// 	log(line, cm.getLineNumber(line))
				// 	if (!line.text) {
				// 		cm.setSelection(CodeMirror.Pos(cms[1].getLineNumber(line), 0), CodeMirror.Pos(cms[1].getLineNumber(line) + 1, 0));
				// 		cm.replaceSelection('')
				// 		// cms[1].replaceRange('', CodeMirror.Pos(cms[1].getLineNumber(line), 0))
				// 		// cms[1].replaceRange('', {line: cms[1].getLineNumber(line), ch: 0}, {line: cms[1].getLineNumber(line), ch: 0})
				// 		// cms[1].replaceRange('', CodeMirror.Pos(cms[1].getLineNumber(line)))
				// 		// cms[1].removeLine(cms[1].getLineNumber(line))
				// 	}

				// })

			}

			// $(document).on("click", '.toggle:not(:first-child)', function(e) {
			// 	if ($(this).nextAll('.CodeMirror:first').width() === 0) {
			// 		$(this).nextAll('.CodeMirror:first').animate({ width: (90/x)+'%' }, 1000)
			// 		$('.CodeMirror:first').animate({ width: '-='+(90/x)+'%' }, 1000)
			// 	}
			// 	else {
			// 		$(this).nextAll('.CodeMirror:first').animate({ width: "0%" }, 1000)
			// 		$('.CodeMirror:first').animate({ width: '+='+(90/x)+'%' }, 1000)
			// 	}
			// })
			// $(document).on("click", '.toggle:first-child', function(e) {
			// 	if ($(this).nextAll('#tree').width() === 0) {
			// 		$(this).nextAll('#tree').animate({ width: '10%' }, 1000)
			// 	}
			// 	else {
			// 		$(this).nextAll('#tree').animate({ width: "0%" }, 1000)
			// 	}
			// })

			$('#tree').before($('<div class="toggle"></div>', {}).css({
				width: $('.CodeMirror-gutters').css('width'),
				height: $('.CodeMirror').css('height'),
				border: $('.CodeMirror-gutters').css('border-right'),
				backgroundColor: $('.CodeMirror-gutters').css('background-color'),
			}))
			$('#tree').css({border: $('.CodeMirror-gutters').css('border-right')})
		})
		$('#genx').click()

		$('#indentStyle').change(function() {
			var ws = $(this).val()
			cms.forEach(function(cm) {
				if (ws === 'tabs') {
					cm.setOption('indentWithTabs', true)
				}
				else {
					cm.setOption('indentWithTabs', false)
					cm.setOption('tabSize', ws)
				}
			})
		}).change()

		$('#mode').change(function() {
			var mode = $(this).val() || 'meta'
			$('#previewPane').remove()
			if (!mode) return
			$('#moder').remove()
			var script = $('<script><\/script>', {src:'codemirror/mode/'+mode+'/'+mode+'.js', id: 'moder'})
			$(document.head).append(script)
			if (cma) {
				cma.setOption('mode', mode)
			}
			else {
				cms.forEach(function(cm) {
					cm.setOption('mode', mode)
				})
			}
		}).change()

		$('#theme').change(function() {
			var theme = $(this).val()
			if (!theme) return
			localStorage.setItem('theme', theme)
			$('#themer').remove()
			var link = $('<link></link>', {rel: 'stylesheet', href:'codemirror/theme/'+theme+'.css', id: 'themer'})
			$(document.body).append(link)
			if (cma) {
				cma.setOption('theme', theme)
			}
			else {
				cms.forEach(function(cm) {
					cm.setOption('theme', theme)
					$(cm.display.wrapper).css({
						border: $('.CodeMirror-gutters').css('border-right'),
					})
					$(cm.display.wrapper).prevAll('.toggle:first').css({
						width: $('.CodeMirror-gutters').css('width'),
						height: $('.CodeMirror').css('height'),
						border: $('.CodeMirror-gutters').css('border-right'),
						backgroundColor: $('.CodeMirror-gutters').css('background-color'),
					})
				})
			}
		})

		$('#compile').click(function() {
			var prev = cms[0].getValue()
			try {
				cms[1].setValue(sweet.compile(cms[0].getValue()).code)
			}
			catch(e) {
				cms[0].setValue(prev)
			}
		})

		var oldLog = console.log;
		console.log = function (message) {
			cms[1].replaceRange(message+'\n', CodeMirror.Pos(cms[1].lastLine()))
			cms[1].setValue(cms[1].getValue().replace(/\n\n$/, '\n'))
			oldLog.apply(console, arguments);
		};

		$('#run').mousedown(function() {
			if (cms[0].getOption('mode') === 'javascript') {
				eval(cms[0].getValue());
			}
		})
		$('#run').click()

		// cms[1].on('gutterClick', function(cm, line, gutter) {
		// 	if (gutter === 'CodeMirror-linenumbers') {
		// 		cm.setSelection(CodeMirror.Pos(line, 0), CodeMirror.Pos(line + 1, 0));
		// 		cms[1].execCommand('test')
		// 	}
		// });
		// cms[0].on('gutterClick', function(cm, line, gutter) {
		// 	log(cm, line, gutter)
		// 	if (gutter === 'CodeMirror-linenumbers') {
		// 		return cm.setSelection(CodeMirror.Pos(line, 0), CodeMirror.Pos(line + 1, 0));
		// 	}
		// });
		var converter = new showdown.Converter({
			excludeTrailingPunctuationFromURLs: true,
			simplifiedAutoLink: true,
			strikethrough: true,
			tables: true,
			mentions: true,
			smoothLivePreview: true,
			encodeEmails: true,
			ghMentions: true,
			ghMentionsLink: 'https://www.matthewmorrone.com/{u}'
		})
		$("#filename").focus(function() {
			$('#files option:selected').prop("selected", false).removeAttr("selected")
			cms[0].setValue('')
		}).blur(function() {
			var filename = $(this).val()

			var ext = filename.split('.').slice(-1) || ''
			$('#mode').val(extensions[ext] || '').change()
		})
		$("#files").click(function() {
			var filename = $(this).val()
			if (!filename) {return}
			localStorage.setItem('filename', filename)
			var ext = filename.split('.').slice(-1) || ''
			var handle = dir+'/'+filename
			$.post('/api/', {
				mode: 'read',
				handle: handle
			}, function(d) {
				cms[0].setValue(d)
				cms[1].setValue('')
				cms[0].execCommand('test')
				$('#mode').val(extensions[ext] || '').change()
				if (cms[0].getOption('mode') === 'htmlmixed') {
					preview(cms[0].getValue(), {
						top: cms[1].display.wrapper.offsetTop,
						left: cms[1].display.wrapper.offsetLeft+cms[1].display.gutters.offsetWidth+1
					})
				}
				if (cms[0].getOption('mode') === 'markdown') {
					preview(converter.makeHtml(cms[0].getValue()), {
						top: cms[1].display.wrapper.offsetTop,
						left: cms[1].display.wrapper.offsetLeft+cms[1].display.gutters.offsetWidth+1
					})
				}
			}, 'text')
		}).click()
		if (localStorage.getItem('theme')) {
			$('#theme').val(localStorage.getItem('theme')).change()
		}
		if (localStorage.getItem('filename')) {
			$('#files').val(localStorage.getItem('filename')).click().focus()
		}

		CodeMirror.on(cms[0], 'keyup', function() {
			var filename = $('#filename').val() || $('#files').val()
			if (!filename) {return}
			var handle = dir+'/'+filename
			if (cms[0].getValue().trim() === "") {
				$.post('/api/', {
					mode: 'rm',
					handle: handle,
				}, function(d) {
					localStorage.removeItem('filename')
					updateFilelist(dir)
				}, 'text')
			}
			else {
				$.post('/api/', {
					mode: 'write',
					handle: handle,
					content: cms[0].getValue()
				}, function(d) {
					$('#filename').val('')
					localStorage.setItem('filename', filename)
					updateFilelist(dir)
				}, 'text')
				var offset = {
					top: cms[1].display.wrapper.offsetTop,
					left: cms[1].display.wrapper.offsetLeft+cms[1].display.gutters.offsetWidth+1
				}
				if (cms[0].getOption('mode') === 'htmlmixed') {
					preview(cms[0].getValue(), offset)
				}
				if (cms[0].getOption('mode') === 'markdown') {
					preview(converter.makeHtml(cms[0].getValue()), offset)
				}
			}
		})
		function preview(content, offset) {
			$("#previewPane").remove()
			var element = $("<div>", {id: 'previewPane', html: content}).css({
				position: 'absolute',
				width: '50%',
				height: '50%',
				display: 'block',
				top: offset.top,
				left: offset.left,
				zIndex: 1,
			})
			$(document.body).append(element)
		}
	});
})
</script>
<nav>
<input type='number' value='2' min='1' max='4' id='genx' class='gen' />
<input type='number' value='1' min='1' max='4' id='geny' class='gen' />
<!-- <input type='number' value='0' min='0' id='baseIndent' /> -->
<!-- <input type='checkbox' id='semicolons' checked /><label for='semicolons'>Semicolons</label> -->
<!-- <input type='checkbox' id='compact' checked /><label for='compact'>Compact</label> -->
<!-- <input type='checkbox' id='bracketFormat' /><label for='bracketFormat'>Brackets</label> -->
<!-- <select id='quotes'>
	<option value='single' selected>Single</option>
	<option value='double'>Double</option>
</select> -->
<!-- <select id='indentStyle'>
	<option value='2'>2 Spaces</option>
	<option value='4'>4 Spaces</option>
	<option value='tabs' selected>Tabs</option>
</select> -->
<select id='mode'>
	<option></option>
	<option value='apl'>apl</option>
	<option value='asciiarmor'>asciiarmor</option>
	<option value='asn.1/asn'>asn</option>
	<option value='asterisk'>asterisk</option>
	<option value='brainfuck'>brainfuck</option>
	<option value='clike'>clike</option>
	<option value='clojure'>clojure</option>
	<option value='cmake'>cmake</option>
	<option value='cobol'>cobol</option>
	<option value='coffeescript'>coffeescript</option>
	<option value='commonlisp'>commonlisp</option>
	<option value='crystal'>crystal</option>
	<option value='css'>css</option>
	<option value='cypher'>cypher</option>
	<option value='d'>d</option>
	<option value='dart'>dart</option>
	<option value='diff'>diff</option>
	<option value='django'>django</option>
	<option value='dockerfile'>dockerfile</option>
	<option value='dtd'>dtd</option>
	<option value='dylan'>dylan</option>
	<option value='ebnf'>ebnf</option>
	<option value='ecl'>ecl</option>
	<option value='eiffel'>eiffel</option>
	<option value='elm'>elm</option>
	<option value='erlang'>erlang</option>
	<option value='factor'>factor</option>
	<option value='fcl'>fcl</option>
	<option value='forth'>forth</option>
	<option value='fortran'>fortran</option>
	<option value='gas'>gas</option>
	<option value='gfm'>gfm</option>
	<option value='gherkin'>gherkin</option>
	<option value='go'>go</option>
	<option value='groovy'>groovy</option>
	<option value='haml'>haml</option>
	<option value='handlebars'>handlebars</option>
	<option value='haskell-literate/haskell'>haskell-literate</option>
	<option value='haskell'>haskell</option>
	<option value='haxe'>haxe</option>
	<option value='htmlembedded'>htmlembedded</option>
	<option value='htmlmixed'>htmlmixed</option>
	<option value='http'>http</option>
	<option value='idl'>idl</option>
	<option value='javascript'>javascript</option>
	<option value='jinja2'>jinja2</option>
	<option value='jsx'>jsx</option>
	<option value='julia'>julia</option>
	<option value='livescript'>livescript</option>
	<option value='lua'>lua</option>
	<option value='markdown'>markdown</option>
	<option value='mathematica'>mathematica</option>
	<option value='mbox'>mbox</option>
	<option value='meta'>meta</option>
	<option value='mirc'>mirc</option>
	<option value='mllike'>mllike</option>
	<option value='modelica'>modelica</option>
	<option value='mscgen'>mscgen</option>
	<option value='mumps'>mumps</option>
	<option value='nginx'>nginx</option>
	<option value='nsis'>nsis</option>
	<option value='ntriples'>ntriples</option>
	<option value='octave'>octave</option>
	<option value='oz'>oz</option>
	<option value='pascal'>pascal</option>
	<option value='pegjs'>pegjs</option>
	<option value='perl'>perl</option>
	<option value='php'>php</option>
	<option value='pig'>pig</option>
	<option value='powershell'>powershell</option>
	<option value='properties'>properties</option>
	<option value='protobuf'>protobuf</option>
	<option value='pug'>pug</option>
	<option value='puppet'>puppet</option>
	<option value='python'>python</option>
	<option value='q'>q</option>
	<option value='r'>r</option>
	<option value='rpm'>rpm</option>
	<option value='rst'>rst</option>
	<option value='ruby'>ruby</option>
	<option value='rust'>rust</option>
	<option value='sas'>sas</option>
	<option value='sass'>sass</option>
	<option value='scheme'>scheme</option>
	<option value='shell'>shell</option>
	<option value='sieve'>sieve</option>
	<option value='slim'>slim</option>
	<option value='smalltalk'>smalltalk</option>
	<option value='smarty'>smarty</option>
	<option value='solr'>solr</option>
	<option value='soy'>soy</option>
	<option value='sparql'>sparql</option>
	<option value='spreadsheet'>spreadsheet</option>
	<option value='sql'>sql</option>
	<option value='stex'>stex</option>
	<option value='stylus'>stylus</option>
	<option value='swift'>swift</option>
	<option value='tcl'>tcl</option>
	<option value='textile'>textile</option>
	<option value='toml'>toml</option>
	<option value='tornado'>tornado</option>
	<option value='troff'>troff</option>
	<option value='ttcn-cfg/ttcn'>ttcn</option>
	<option value='ttcn'>ttcn</option>
	<option value='turtle'>turtle</option>
	<option value='twig'>twig</option>
	<option value='vb'>vb</option>
	<option value='vbscript'>vbscript</option>
	<option value='velocity'>velocity</option>
	<option value='verilog'>verilog</option>
	<option value='vhdl'>vhdl</option>
	<option value='vue'>vue</option>
	<option value='webidl'>webidl</option>
	<option value='xml'>xml</option>
	<option value='xquery'>xquery</option>
	<option value='yacas'>yacas</option>
	<option value='yaml-frontmatter'>yaml-frontmatter</option>
	<option value='yaml'>yaml</option>
	<option value='z80'>z80</option>
</select>
<select id='theme'>
	<option value='3024-day'>3024-day</option>
	<option value='3024-night'>3024-night</option>
	<option value='abcdef'>abcdef</option>
	<option value='ambiance'>ambiance</option>
	<option value='ambiance-mobile'>ambiance-mobile</option>
	<option value='base16-dark'>base16-dark</option>
	<option value='base16-light'>base16-light</option>
	<option value='bespin'>bespin</option>
	<option value='blackboard'>blackboard</option>
	<option value='cobalt'>cobalt</option>
	<option value='colorforth'>colorforth</option>
	<option value='dracula'>dracula</option>
	<option value='duotone-dark'>duotone-dark</option>
	<option value='duotone-light'>duotone-light</option>
	<option value='eclipse' selected>eclipse</option>
	<option value='elegant'>elegant</option>
	<option value='erlang-dark'>erlang-dark</option>
	<option value='hopscotch'>hopscotch</option>
	<option value='icecoder'>icecoder</option>
	<option value='isotope'>isotope</option>
	<option value='lesser-dark'>lesser-dark</option>
	<option value='liquibyte'>liquibyte</option>
	<option value='material'>material</option>
	<option value='mbo'>mbo</option>
	<option value='mdn-like'>mdn-like</option>
	<option value='midnight'>midnight</option>
	<option value='monokai'>monokai</option>
	<option value='neat'>neat</option>
	<option value='neo'>neo</option>
	<option value='night'>night</option>
	<option value='panda-syntax'>panda-syntax</option>
	<option value='paraiso-dark'>paraiso-dark</option>
	<option value='paraiso-light'>paraiso-light</option>
	<option value='pastel-on-dark'>pastel-on-dark</option>
	<option value='railscasts'>railscasts</option>
	<option value='rubyblue'>rubyblue</option>
	<option value='seti'>seti</option>
	<option value='solarized'>solarized</option>
	<option value='the-matrix'>the-matrix</option>
	<option value='tomorrow-night-bright'>tomorrow-night-bright</option>
	<option value='tomorrow-night-eighties'>tomorrow-night-eighties</option>
	<option value='ttcn'>ttcn</option>
	<option value='twilight'>twilight</option>
	<option value='vibrant-ink'>vibrant-ink</option>
	<option value='xq-dark'>xq-dark</option>
	<option value='xq-light'>xq-light</option>
	<option value='yeti'>yeti</option>
	<option value='zenburn'>zenburn</option>
</select>
<!-- <button id='compile'>Compile</button> -->
<button id='run'>Run</button>
</nav>
<main>
<div id='tree'>
<input type='text' id='filename' />
<select id='files' size=4></select>
</div>
</main>

</body>
</html>